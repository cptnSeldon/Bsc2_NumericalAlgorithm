<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Labo 3 | Equipe 4</title>
    <style>
        body { font-family: 'Calibri', 'Arial', sans-serif;}
    </style>
</head>
<body onload="onLoadBody();">
<h2>Labo 3 : Présentation de la méthode de Gauss</h2>
<p><label>Fichier Json à charger : <input type="file" name="inputFile" id="inputFile" accept=".json"/></label></p>
<p><label><input type="submit" name="submit" id="submit" value="Charger le fichier"/></label></p>
<script>
    /**
     * Input file Listener
     */
//    document.getElementById('inputFile').addEventListener('change', handleFileSelect, false);
    document.getElementById('submit').addEventListener('click', function(){
        handleFileSelect(document.getElementById('inputFile'));
    });

    /*****************************************************************************
     * READ JSON FILE
     *****************************************************************************/

    /**
     * Check for the various File API support.
     */
    function onLoadBody(){
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            // Great success! All the File APIs are supported.
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }
    }

    /**
     *  Read local file
     */
    function handleFileSelect(evt) {
        var file = document.getElementById('inputFile').files[0]; // File object

        var reader = new FileReader();

        // Closure to capture the file information.
        reader.onload = (function(theFile) {
            return function(e) {
                // Use data
                test(e.target.result.toString());
            };
        })(file);

        // Read in the file.
        reader.readAsText(file);

    }

    /**
     *
     */
    function test(obj) {
        var json = json2array(JSON.parse(obj.toString()));
        var A = json[0];
        var B = json[1][0];

        var sol = gauss(A, B);
        alert(sol);
    }

    /**
     * Convert json object to array
     */
    function json2array(json){
        var result = [];
        var keys = Object.keys(json);
        keys.forEach(function(key){
            result.push(json[key]);
        });
        return result;
    }


    /*****************************************************************************
     * GAUSS
     *****************************************************************************/

    /**
     * Reverse rows and cols of the matrix A
     * => Li <-> Lj
     *
     * @param A
     * @param i
     * @param j
     */
    function changeLine(A, i, j) {
        var tmp = A[i];
        A[i] = A[j];
        A[j] = tmp;
    }

    /**
     * Transvection of the matrix A
     * => Li <-Li + mu*Lj
     * Wikipédia - https://en.wikipedia.org/wiki/Shear_mapping
     *
     * @param A
     * @param i
     * @param j
     * @param mu
     */
    function transvection(A, i, j, mu) {
        // If A is a column matrix
        if(!Array.isArray(A[0])){
            A[i] = A[i] + (mu*A[j]);
        } else {
            // Number of cols
            var n = A[0].length;
            for(var k = 0; k < n; k++) {
                A[i][k] = A[i][k] + (mu * A[j][k]);
            }
        }
    }

    /**
     * Maximum Pivot
     *
     * @param A
     * @param j0
     * @returns {*}
     */
    function pivot_partiel(A, j0) {
        // Rows of A
        var n = A.length;
        // Index of row with max pivot
        var iMax = j0;
        for(var i = j0+1; i < n; i++) {
            if(Math.abs(A[i][j0]) > Math.abs(A[iMax][j0])) {
                iMax = i;
            }
        }
        return iMax;
    }

    /**
     * Solution of Ax=b
     * A is a upper triangular matrix
     *
     * @param A
     * @param b
     * @returns {Array}
     */
    function triangle(A, b) {
        var n = b.length;
        var x = new Array(n+1).join('0').split('').map(parseFloat);
        x[n-1] = b[n-1]/A[n-1][n-1];
        for(var i = n-2; i >= 0; i--) {
            var s = 0;
            for(var j = i+1; j < n; j++) {
                s = s + (A[i][j] * x[j]);
            }
            x[i] = (b[i] - s)/A[i][i];
        }
        return x;
    }

    function gauss(A0, b0) {
        // Deep copy (doesn't destroy the original matrix)
        var A = A0.slice(0);
        var b = b0.slice(0);
        var n = A.length;
        // Triangulation
        for(var i = 0; i < n-1; i++) {
            var i0 = pivot_partiel(A, i);
            changeLine(A, i, i0);
            changeLine(b, i, i0);
            for(var k = i+1; k < n; k++) {
                var x = A[k][i]/A[i][i];
                transvection(A, k, i, -x);
                transvection(b, k, i, -x);
            }
        }
        return triangle(A, b);
    }


</script>
</body>
</html>