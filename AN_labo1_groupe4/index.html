<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Labo 1 - Equipe 4</title>
    </head>
    <style>
        html { font-family: sans-serif;}
        table{ border-collapse: collapse;  }
        table td{  padding: 3px; }
        /* Border right to first, second and last cells */
        table tr td:first-child,  th:first-child, td:nth-child(2), th:nth-child(2), td:last-child, th:last-child{
            border-right: 1px solid black;
        }
        /* Border to the "operation" row */
        table tr.operation {
            border-top: 1px solid black;
            border-bottom: 1px solid black;
        }
    </style>
    <body>
    <h2>Labo 1 - Codage flottant</h2>
    <p><label>Nombre de bits <input type="number" name="nbBits" id="nbBits" value="8" max="80" min="4" autofocus/></label></p>
    <p><label>32 bits <sub>(IEE Std 754-1985)</sub><input type="radio" name="ieee" id="32bits"/></label></p>
    <p><label>64 bits <sub>(IEE Std 754-1985)</sub><input type="radio" name="ieee" id="64bits"/></label></p>
    <br/>
    <!-- TABLE -->
    <table>
        <!-- Title row -->
        <tr>
            <th></th><th>Décimal</th><th colspan="3">Binaire</th>
        </tr>
        <!-- First Number -->
        <tr>
            <td></td><td></td><td>s</td><td>e</td><td>m</td>
        </tr>
        <tr>
            <td rowspan="2">Nombre 1 </td>
            <td><input type="number" name="nbDec1" id="nbDec1" step="any" size="20"/></td>
            <td><input type="text" name="s1" id="s1" maxlength="1" size="1"/></td>
            <td><input type="text" name="e1" id="e1" maxlength="6" size="6"/></td>
            <td><input type="text" name="m1" id="m1" maxlength="6" size="6"/></td>
        </tr>
        <tr>
            <td></td><td colspan="3"><label id="nbBin1"></label></td>
        </tr>
        <!-- Second Number -->
        <tr>
            <td></td><td></td><td>s</td><td>e</td><td>m</td>
        </tr>
        <tr>
            <td rowspan="2">Nombre 2 </td>
            <td><input type="number" name="nbDec2" id="nbDec2" step="any"/></td>
            <td><input type="text" name="s2" id="s2" maxlength="1" size="1"/></td>
            <td><input type="text" name="e2" id="e2" maxlength="6" size="6"/></td>
            <td><input type="text" name="m2" id="m2" maxlength="6" size="6"></td>
        </tr>
        <tr>
            <td></td><td colspan="3"><label id="nbBin2"></label></td>
        </tr>
        <!--  "Operation" row -->
        <tr class="operation">
            <td>Opérations</td>
            <td colspan="4">
                <button type="button" name="btnAdd" id="btnAdd">+</button>
            </td>
        </tr>
        <!-- Result row -->
        <tr>
            <td>Résultat </td>
            <td><input type="number" name="resultDec" id="resultDec" step="any" size="20" disabled/></td>
            <td colspan="3"><input type="text" name="resultBin" id="resultBin" maxlength="8" size=8" disabled/></td>

        </tr>
    </table>
    <!-- TABLE END -->
    <script>
        // *****************************************************************************************
        // Listening inputs
        // *****************************************************************************************
        document.getElementById("nbBits").addEventListener("change", function() {
            this.value = (parseInt(this.value) < 4) ? 4 : this.value;
            this.value = (parseInt(this.value) > 80) ? 80 : this.value;
            resetInput();
        });
        document.getElementById("32bits").addEventListener("click", function() {resetInput();});
        document.getElementById("64bits").addEventListener("click", function() {resetInput();});

        // Initialize radio buttons when the focus is on the input "nbBits"
        document.getElementById("nbBits").addEventListener("focus", function() {
            document.getElementById("32bits").checked=false;
            document.getElementById("64bits").checked=false;
            resetInput();
        });

        // NUMBER 1
        // Conversion decimal to binary
        document.getElementById("nbDec1").addEventListener("keyup", function (event) {decToBin(1);});
        // Conversion binary to decimal
        document.getElementById("s1").addEventListener("keyup", function () {eventBinInput(this, 1);});
        document.getElementById("e1").addEventListener("keyup", function () {eventBinInput(this, 1);});
        document.getElementById("m1").addEventListener("keyup", function () {eventBinInput(this, 1);});

        // NUMBER 2
        // Conversion decimal to binary
        document.getElementById("nbDec2").addEventListener("keyup", function (event) {decToBin(2);});
        // Conversion binary to decimal
        document.getElementById("s2").addEventListener("keyup", function () {eventBinInput(this, 2);});
        document.getElementById("e2").addEventListener("keyup", function () {eventBinInput(this, 2);});
        document.getElementById("m2").addEventListener("keyup", function () {eventBinInput(this, 2);});

        // ADDITION
        document.getElementById("btnAdd").addEventListener("click", function(){addition();});

        // *****************************************************************************************
        // Functions
        // *****************************************************************************************
        /**
         * Conversion decimal to binary [float]
         * @param id : Reference the number to convert
         */
        function decToBin(id){
            // Value without sign
            var nb = Math.abs(document.getElementById("nbDec"+id).value);
            // Sign of value. Detect the difference between positive and negative zero
            // Example : 1/(-0) = "-Infinity" AND 1/0 = "Infinity"
            var S = 1/document.getElementById("nbDec"+id).value;
            var exp = Math.log(nb)/Math.log(2.0);
            if(exp >= 0){
                exp = parseInt(exp);
            } else {
                exp = Math.floor(exp);
            }
            var e = [];
            var m = [];
            var E = 0;
            var n = 0;
            var d = 0;
            var args = []
            if(isRadioBtnChecked(args)) {
                d = args[0];
                E = args[1];
                n = args[2];
            }else{
                var N = document.getElementById("nbBits").value;
                if(isFinite(exp)) {
                    E = Math.ceil(1.0 + (Math.log(Math.abs(exp) + 1.0) / Math.log(2.0)));
                } else {
                    E = N/2;
                }
                d = Math.pow(2,E-1)-1;
                n = N-E-1;
            }
            if(isNaN(nb) || nb == 0){
                // Mantissa
                for(var i= 0;i<n;i++) {
                    m[i]=0;
                }
                //Exposant
                for(var i=0;i<E;i++) {
                    e[i] = 0;
                }
            }
            else {
                // Mantissa
                var tmp = nb / Math.pow(2,exp);
                for(var i = 0;i < n;i++) {
                    if(tmp >= 1) {
                        tmp -= parseInt(tmp);
                    }
                    tmp *= 2;
                    m[i] = parseInt(tmp);
                }
                //Exposant
                var ePrime = d + exp;
                var quotient = 1;
                var i = 0;
                // Conversion décimal -> binaire
                while (i < E) {
                    quotient = parseInt(ePrime / 2);
                    e[i] = ePrime % 2;
                    ePrime = quotient;
                    i++;
                }
            }
            // Signe
            var s = (S < 0) ? 1 : 0;
            // Affichage du résultat
            document.getElementById("s"+id).value = s;
            document.getElementById("e"+id).value = e.reverse().join("");
            document.getElementById("m"+id).value = m.join("");
            copyInputToLabel(id);
        }

        /**
         * Conversion binary to decimal [float]
         * @param id : Reference the number to convert
         */
		function binToDec(id){
			// Signe
			var s = parseInt(document.getElementById("s"+id).value);
			var S = -2*s+1;
			// Exposant
			var e = document.getElementById("e"+id).value.split("").reverse();
			var E = e.length;
			var ePrime=0;
			for(var i=0; i < E; i++){
                if(e[i] == "1"){
                    ePrime += Math.pow(2,i);
                }
            }
			//(2^E-1)-1 -> d
			var d = Math.pow(2,E-1)-1;
			// Mantissa
            var m = document.getElementById("m"+id).value.split("").reverse();
			var n = m.length;
            var M = 0;
			for(var i = 0; i < m.length; i++){
				if(m[i] == "1"){
					M += Math.pow(2,i);
				}
            }
            // If mantissa and exposant are equal to 0, the result is 0
            M += (M > 0 || ePrime > 0) ? Math.pow(2, n) : 0;
			M /= Math.pow(2, n);

			var x = S*M*Math.pow(2,ePrime-d);
			document.getElementById("nbDec"+id).value = x;
		}

        /**
         * Addition of two binary/decimal numbers
         */
        function addition() {
            //alert("Addition of two binary numbers");
			var s1 = document.getElementById("s1").value;
			var e1 = document.getElementById("e1").value;
			var m1 = document.getElementById("m1").value;
			var s2 = document.getElementById("s2").value;
			var e2 = document.getElementById("e2").value;
			var m2 = document.getElementById("m2").value;
			if(s1.length != s2.length || e1.length != e2.length || m1.length != m2.length) {
				alert("Les deux nombres n'ont pas le même nombre de bits ou ne sont pas répartis de la même manière.");
			} else if (s1.length == 0 || e1.length == 0 || m1.length == 0) {
				alert("Les champs sont vide.");
			}else if (s1.length + e1.length + m1.length > document.getElementById("nbBits").value && !isRadioBtnChecked()){
				alert("Les nombres dépassent la taille définie.");
			} else {
                // Addition Binary
				document.getElementById("resultBin").value = "Addition of two binary numbers";
				
				// Addition Decimal
				var resultDec = parseFloat(document.getElementById("nbDec1").value) + parseFloat(document.getElementById("nbDec2").value);
				document.getElementById("resultDec").value = resultDec;
			}
        }

        /**
         * Call by the input listener (Binary input)
         * @param input : The input
         * @param id    : ID to know which number is treated
         */
        function eventBinInput(input, id) {
            // If there are characters other than 0 or 1, they are replaced by 0.
            if(/[^01]/i.test(input.value)){
                input.value = input.value.replace(RegExp('[^01]', 'i'), "0");
            }
            var s = document.getElementById("s"+id).value.length;
            var e = document.getElementById("e"+id).value.length;
            var m = document.getElementById("m"+id).value.length;
            var N = document.getElementById("nbBits").value;
            // Inform the user if the binary number is too long
            if(s+e+m <= N || isRadioBtnChecked()) {
                copyInputToLabel(id);
                binToDec(id);
            } else {
                document.getElementById("nbDec"+id).value = "";
                alert("Le nombre " + id + " a trop de bits.");
            }
        }

        /**
         * Verify if the 32 or 64 bits radio button is checked.
         * The list passed by reference is used to return the values defined by the standard
         * @param args : List passed by reference
         */
        function  isRadioBtnChecked(args){
            if(document.getElementById("32bits").checked == true){
                if(args !== undefined) {
                    args[0] = 127;
                    args[1] = 8;
                    args[2] = 23;
                    args[3] = 32;
                }
                return true;
            } else if(document.getElementById("64bits").checked == true){
                if(args !== undefined) {
                    args[0] = 1023;
                    args[1] = 11;
                    args[2] = 52;
                    args[3] = 64;
                }
                return true;
            }else{
                return false;
            }
        }

        /**
         * Reset all inputs and set the maxlength of each
         */
        function resetInput(){
            for(var id=1; id<=2; id++) {
                document.getElementById("s"+id).value = "";
                document.getElementById("e"+id).value = "";
                document.getElementById("m"+id).value = "";
                document.getElementById("nbDec"+id).value = "";
                document.getElementById("nbBin"+id).innerHTML = "";
            }
            document.getElementById("resultBin").value = "";
            document.getElementById("resultDec").value = "";
            var maxLength = document.getElementById("nbBits").value;
            var args = [];
            var E = 0;
            var n = 0;

            if(maxLength != "" && maxLength != "0") {
                E = parseInt(maxLength)-2;
                n = E;
                maxLength = maxLength;
            }
            if (isRadioBtnChecked(args)) {
                E = args[1];
                n = args[2];
                maxLength = args[3];
            }

            for(var id=1; id<=2; id++) {
                document.getElementById("e"+id).maxLength = E;
                document.getElementById("e"+id).setAttribute("size", E);
                document.getElementById("m"+id).maxLength = n;
                document.getElementById("m"+id).setAttribute("size", n);
            }

            document.getElementById("resultBin").maxLength = maxLength;
            document.getElementById("resultBin").setAttribute("size", maxLength);
        }

        /**
         * Copy the value of each part of binary number to one label
         * @param id : ID of the number
         */
        function copyInputToLabel (id) {
            var s = document.getElementById("s"+id).value;
            var e = document.getElementById("e"+id).value;
            var m = document.getElementById("m"+id).value;
            document.getElementById("nbBin"+id).innerHTML = s + e + m;
        }

    </script>
    </body>
</html>