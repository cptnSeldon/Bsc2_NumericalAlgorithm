<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Labo 1 - Equipe 4</title>
    </head>
    <style>
        html { font-family: sans-serif;}
        table{ border-collapse: collapse;  }
        table td{  padding: 3px; }
        /* Border right to first, second and last cells */
        table tr td:first-child,  th:first-child, td:nth-child(2), th:nth-child(2), td:last-child, th:last-child{
            border-right: 1px solid black;
        }
        /* Border to the "operation" row */
        table tr.operation {
            border-top: 1px solid black;
            border-bottom: 1px solid black;
        }
    </style>
    <body onload="init()">
    <h2>Labo 1 - Codage flottant</h2>
    <p><label>Nombre de bits <input type="number" name="nbBits" id="nbBits" value="32" min="6" max="256" autofocus/></label></p>
    <br/>
    <!-- TABLE -->
    <table>
        <!-- Title row -->
        <tr>
            <th></th><th>Décimal</th><th colspan="3">Binaire</th>
        </tr>
        <!-- First Number -->
        <tr>
            <td></td><td></td><td>s</td><td>e</td><td>m</td>
        </tr>
        <tr>
            <td rowspan="2">Nombre 1 </td>
            <td><input type="number" name="nbDec1" id="nbDec1" step="any" size="20"/></td>
            <td><input type="text" name="s1" id="s1" maxlength="1" size="1"/></td>
            <td><input type="text" name="e1" id="e1" maxlength="6" size="6"/></td>
            <td><input type="text" name="m1" id="m1" maxlength="6" size="6"/></td>
        </tr>
        <tr>
            <td></td><td colspan="3"><label id="nbBin1"></label></td>
        </tr>
        <!-- Second Number -->
        <tr>
            <td></td><td></td><td>s</td><td>e</td><td>m</td>
        </tr>
        <tr>
            <td rowspan="2">Nombre 2 </td>
            <td><input type="number" name="nbDec2" id="nbDec2" step="any"/></td>
            <td><input type="text" name="s2" id="s2" maxlength="1" size="1"/></td>
            <td><input type="text" name="e2" id="e2" maxlength="6" size="6"/></td>
            <td><input type="text" name="m2" id="m2" maxlength="6" size="6"></td>
        </tr>
        <tr>
            <td></td><td colspan="3"><label id="nbBin2"></label></td>
        </tr>
        <!--  "Operation" row -->
        <tr class="operation">
            <td>Opérations</td>
            <td colspan="4">
                <button type="button" name="btnAdd" id="btnAdd">+</button>
            </td>
        </tr>
        <!-- Result row -->
        <tr>
            <td>Résultat </td>
            <td><input type="number" name="resultDec" id="resultDec" step="any" size="20" disabled/></td>
            <td colspan="3"><input type="text" name="resultBin" id="resultBin" maxlength="8" size=8" disabled/></td>

        </tr>
    </table>
    <!-- TABLE END -->
	<br>
	<!-- LABEL START -->
    <h3>Mode d'Emploi</h3>
    <p>
        <ul>
            <li>Choisir le nombre de bits total.</li>
            <li>Ecrire un nombre dans le champ binaire ou
                décimal, la conversion se fait automatiquement.</li>
            <li>Lorsque tous les champs sont remplis, pressez sur
                la touche [+] pour effectuer l'addition.</li>
        </ul>
    </p>
    <h3>Spécificités</h3>
    <p>L'application permet de convertir des nombres décimaux flottants en binaire (vice versa) ainsi que de faire des additions.</p>
	<p>Le calcul de la taille des bits de l'exposant a été déterminé en faisant un graphe des valeurs en utilisant les informations liées à la norme IEEE754.
		<br>Après avoir récupéré ces valeurs, une courbe de tendance logarithmique est appliquée sur le graphe.
		<br>Grâce à elle, on a pu établir que la relation entre le nombre total de bits et celui de l'exposant est approximativement de :
	</p>
	<p>3*Log<sub>2</sub>(nombre_de_bits_total) - 7</p>
	<p>Ainsi, on arrive à minimiser les erreurs qui auraient pu survenir en utilisant un nombre de bits plus aléatoire.</p>
	<p>Le nombre de bits total minimal est de 6 bits, en suivant cette formule.
       <br>Le nombre de bits total maximal a été fixé à 256 bien qu'à partir d'environ 80 bits il s'ensuit une longue suite composée uniquement de 0.
	</p>
    <p>On n'a pas réussi à rendre l'addition possible pour les nombres qui ne sont pas du même signe.</p>
	<hr>
	<sup>Equipe 4</sup>
    <!-- LABEL END -->
    <script>
        // *****************************************************************************************
        // Listening inputs
        // *****************************************************************************************
        document.getElementById("nbBits").addEventListener("change", function() {
            this.value = (parseInt(this.value) < 6) ? 6 : this.value;
            this.value = (this.value == "") ? 6 : this.value;
			this.value = (parseInt(this.value) > 256) ? 256 : this.value;
            resetInput();
            if(document.getElementById("nbDec1").value != "")
                    decToBin(1);
            if(document.getElementById("nbDec2").value != "")
                    decToBin(2);
        });
        // NUMBER 1
        // Conversion decimal to binary
        document.getElementById("nbDec1").addEventListener("keyup", function (event) {decToBin(1);});
        // Conversion binary to decimal
        document.getElementById("s1").addEventListener("keyup", function () {eventBinInput(this, 1);});
        document.getElementById("e1").addEventListener("keyup", function () {eventBinInput(this, 1);});
        document.getElementById("m1").addEventListener("keyup", function () {eventBinInput(this, 1);});

        // NUMBER 2
        // Conversion decimal to binary
        document.getElementById("nbDec2").addEventListener("keyup", function (event) {decToBin(2);});
        // Conversion binary to decimal
        document.getElementById("s2").addEventListener("keyup", function () {eventBinInput(this, 2);});
        document.getElementById("e2").addEventListener("keyup", function () {eventBinInput(this, 2);});
        document.getElementById("m2").addEventListener("keyup", function () {eventBinInput(this, 2);});

        // ADDITION
        document.getElementById("btnAdd").addEventListener("click", function(){addition();});

        // *****************************************************************************************
        // Functions
        // *****************************************************************************************
        /**
         * Conversion decimal to binary [float]
         * @param id : Reference the number to convert
         */
        function decToBin(id){
            // Value without sign
            var nb = Math.abs(document.getElementById("nbDec"+id).value);
            // Sign of value. Detect the difference between positive and negative zero
            // Example : 1/(-0) = "-Infinity" AND 1/0 = "Infinity"
            var S = 1/document.getElementById("nbDec"+id).value;
            var exp = Math.floor(Math.log(nb)/Math.log(2.0));
            var N = parseInt(document.getElementById("nbBits").value);
            var E = document.getElementById("e"+id).maxLength;
            var d = Math.pow(2,E-1)-1;
            var n = N-E-1;
            var e = [];
            var m = [];

			// If zero
            if(isNaN(nb) || nb == 0){
                // Mantissa
                for(var i= 0;i<n;i++) {
                    m[i]=0;
                }
                //Exposant
                for(var i=0;i<E;i++) {
                    e[i] = 0;
                }
            }
            else {
                // Mantissa
                var tmp = nb / Math.pow(2,exp);
                for(var i = 0;i <= n;i++) {
                    if(tmp >= 1) {
                        tmp -= parseInt(tmp);
                    }
                    tmp *= 2;
                    m[i] = parseInt(tmp);
                }
				// Round Mantissa
				var tmp = m.pop()
				if(tmp == 1) {
					var one = [];
					var old_m = m;
					for (var i = 0; i < m.length; i++) { one[i] = "0";}
                    one[m.length - 1] = "1";
                    binaryAdd(old_m.reverse(), one.reverse(), m);
				}
                //Exponent
                var ePrime = d + exp;
                var quotient = 1;
                var i = 0;
                while (i < E) {
                    quotient = parseInt(ePrime / 2);
                    e[i] = ePrime % 2;
                    ePrime = quotient;
                    i++;
                }
            }
            // Sign
            var s = (S < 0) ? 1 : 0;
			
            // Display result
            document.getElementById("s"+id).value = s;
            document.getElementById("e"+id).value = e.reverse().join("");
            document.getElementById("m"+id).value = m.join("");
            copyInputToLabel(id);
        }

        /**
         * Conversion binary to decimal [float]
         * @param id : Reference the number to convert
         */
		function binToDec(id){
			// Sign
			var s = parseInt(document.getElementById("s"+id).value);
			var S = -2*s+1;
			// Exposant
			var e = document.getElementById("e"+id).value.split("").reverse();
			var E = e.length;
			var ePrime=0;
			for(var i=0; i < E; i++){
                if(e[i] == "1"){
                    ePrime += Math.pow(2,i);
                }
            }
			//(2^E-1)-1 -> d
			var d = Math.pow(2,E-1)-1;
			// Mantissa
            var m = document.getElementById("m"+id).value.split("").reverse();
			var n = m.length;
            var M = 0;
			for(var i = 0; i < m.length; i++){
				if(m[i] == "1"){
					M += Math.pow(2,i);
				}
            }
            // If mantissa and exposant are equal to 0, the result is 0
            M += (M > 0 || ePrime > 0) ? Math.pow(2, n) : 0;
			M /= Math.pow(2, n);

			// Display Result
			var x = S*M*Math.pow(2,ePrime-d);
			document.getElementById("nbDec"+id).value = x;
		}

        /**
         * Addition of two binary/decimal numbers
         */
        function addition() {
			var s1 = document.getElementById("s1").value;
			var e1 = document.getElementById("e1").value;
			var m1 = document.getElementById("m1").value;
			var s2 = document.getElementById("s2").value;
			var e2 = document.getElementById("e2").value;
			var m2 = document.getElementById("m2").value;
			if(s1.length != s2.length || e1.length != e2.length || m1.length != m2.length) {
				alert("Les deux nombres n'ont pas le même nombre de bits ou ne sont pas répartis de la même manière.");
			} else if (s1.length == 0 || e1.length == 0 || m1.length == 0) {
				alert("Les champs sont vide.");
			} else if (s1 != s2) {
				alert("Les nombres ne sont pas de même signe.");
			} else {
                // Addition Binary
				// Convert to array
                m1 = "1" + m1;
                m2 = "1" + m2;
                m1 = m1.split("");
                m2 = m2.split("");
				
				// Get exponent
				var exp1 = getExponent(e1);
				var exp2 = getExponent(e2);

				//If exp1 > exp2 : positive -> the n°2 shift
				//If exp2 > exp1 : négatif -> the n°1 shift
				//If exp1 = exp2 : 0 -> no shift
				// Get shift
				var shift = getShift(parseInt(exp1), parseInt(exp2));
                var eResult = e1;

				// Shift is possible
				if(Math.abs(shift) <= m1.length-1){
                    // Bits1 shift
                    if(shift < 0){
                        for(var i=0; i<Math.abs(shift); i++) {
                            m1.unshift("0");
                            m1.pop();
                        }
                        eResult = e2;
                    }
                    // Bits2 shift
                    else if(shift > 0){
                        for(var i=0; i<shift; i++) {
                            m2.unshift("0");
                            m2.pop();
                        }
                    }
				}
				// Shift is not possible
				else{
					if(shift < 0)
						document.getElementById("resultBin").value = document.getElementById("nbBin1").value;
					else
						document.getElementById("resultBin").value = document.getElementById("nbBin2").value;
                }
				// Addition
                var mResult = [];
				var flag = binaryAdd(m1.reverse(), m2.reverse(), mResult);
                if(flag == 1) {
					// Round conditions
                    if (mResult[mResult.length - 1] == "1") {
                        if (mResult[mResult.length - 2] == "1") {
                            mResult.pop();
                            var old_result = mResult;
                            var one = [];
                            for (var i = 0; i < mResult.length - 1; i++) {one[i] = "0";}
                            one[mResult.length - 1] = "1";
                            binaryAdd(old_result.reverse(), one.reverse(), mResult);
                        } else {
                            mResult.pop();
                        }
                    } else {
                        mResult.pop();
                    }
                } else {
                    mResult.shift();
                }

				// Exponent
                eResult = eResult.split("");
                var a = flag;
                var quotient = 1;
                var i = 0;
                var shiftBin = [];
                while (i < eResult.length) {
                    quotient = parseInt(a/ 2);
                    shiftBin[i] = a % 2;
                    a = quotient;
                    i++;
                }
                var old_result = eResult;
                binaryAdd(old_result.reverse(), shiftBin, eResult);
				
				// Addition Decimal
				var resultDec = parseFloat(document.getElementById("nbDec1").value) + parseFloat(document.getElementById("nbDec2").value);
				
				// Results
				document.getElementById("resultDec").value = resultDec;
                document.getElementById("resultBin").value = s1 + eResult.join("") + mResult.join("");
			}
        }
		
		/**
         *  Get shift (difference between two exponents)
         *  @param exp1     : First exponent (int)
         *  @param exp2     : Second exponent (int)
         *  @return shift   : Value of shift
         */
		function getShift(exp1, exp2){
			var x = 0;
			if(exp1 > exp2){
                x = 1;
			}
			else if(exp1 < exp2){
                x = -1;
			}
            return x*Math.abs(exp1 - exp2);
		}

		/**
         *  Get the exponent in decimal
         *  @param exponent : Binary Exponent (String)
         *  @return exp     : Decimal Exponent
         */
        function getExponent(exponent){

            var e = exponent.split("").reverse();
            var E = e.length;
            var ePrime=0;

            for(var i=0; i < E; i++){
                if(e[i]=="1"){
                    ePrime += Math.pow(2,i);
                }
            }
            exp = ePrime - (Math.pow(2,E-1)-1);
            return exp;
        }

        /**
         *  Binary Addition
         *  @param nb1      : First binary number (Array)
         *  @param nb2      : Second binary number (Array)
         *  @param result   : Result of addition (Reference)
         *  @return flag    : Overflow
         */
		function binaryAdd(nb1BinTab, nb2BinTab, result){
            // Le flag = La Retenue
            var flag = 0;
            var tmp = 0;
            // Addition bits à bits
            for(var i = 0; i < nb1BinTab.length; i++) {
                tmp = parseInt(nb1BinTab[i]) + parseInt(nb2BinTab[i]) + flag;
                if(tmp <= 1) {
                    flag = 0;
                    result[i] = tmp;
                } else {
                    flag = 1;
                    result[i] = tmp % 2;
                }
            }
			result = result.reverse();
			
            return flag;
        }
		/**
         *  Calculate the two's Complement
         *  @param nbTabBin : Binary number in array
         */
		function twoComplement(nbTabBin) {
            var result = 0;

            for(var i = 0; i < nbTabBin.length; i++) {
                if(parseInt(nbTabBin[i]) === 0)
					nbTabBin[i] = 1;
                else
					nbTabBin[i] = 0;
            }

            var oneTabBin = [];
            oneTabBin[0] = 1;
            for(var i = 1; i < nbTabBin.length; i++) {
                oneTabBin[i] = 0;
            }

            result = binaryAdd(nbTabBin, oneTabBin);

            return result;
        }

		/**
		 *	Call when page load
		 */
        function init() {
            resetInput()
            document.getElementById("nbDec1").value = "";
            document.getElementById("nbDec2").value = "";
        }

        /**
         * Call by the input listener (Binary input)
         * @param input : The input
         * @param id    : ID to know which number is treated
         */
        function eventBinInput(input, id) {
            // If there are characters other than 0 or 1, they are replaced by 0.
            if(/[^01]/i.test(input.value)){
                input.value = input.value.replace(RegExp('[^01]', 'i'), "0");
            }
            copyInputToLabel(id);
            binToDec(id);
        }

        /**
         * Reset all inputs and set the maxlength of each
         */
        function resetInput(){
            for(var id=1; id<=2; id++) {
                document.getElementById("s"+id).value = "";
                document.getElementById("e"+id).value = "";
                document.getElementById("m"+id).value = "";
                document.getElementById("nbBin"+id).innerHTML = "";
            }
            document.getElementById("resultBin").value = "";
            document.getElementById("resultDec").value = "";
            var N = document.getElementById("nbBits").value;
            var E = Math.ceil(3*(Math.log(N)/Math.log(2))-7);
            var n = N-E-1;

            for(var id=1; id<=2; id++) {
                document.getElementById("e"+id).maxLength = E;
                document.getElementById("e"+id).setAttribute("size", E);
                document.getElementById("m"+id).maxLength = n;
                document.getElementById("m"+id).setAttribute("size", n);
            }

            document.getElementById("resultBin").maxLength = N;
            document.getElementById("resultBin").setAttribute("size", N);
        }

        /**
         * Copy the value of each part of binary number to one label
         * @param id : ID of the number
         */
        function copyInputToLabel (id) {
            var s = document.getElementById("s"+id).value;
            var e = document.getElementById("e"+id).value;
            var m = document.getElementById("m"+id).value;
            document.getElementById("nbBin"+id).innerHTML = s + e + m;
        }

    </script>
    </body>
</html>